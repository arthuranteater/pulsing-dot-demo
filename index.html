<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pulsing Dot CSS Demo with Mapbox</title>
    <!-- Mapbox GL JS -->
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js'></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            font-family: Arial, sans-serif;
            color: white;
        }

        .demo-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 40px;
            padding: 20px;
        }

        .demo-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .demo-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .pulse-dot {
            position: relative;
            width: 75px;
            height: 75px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pulse-ring {
            position: absolute;
            border-radius: 50%;
            animation: pulse 2s cubic-bezier(0.455, 0.03, 0.515, 0.955) infinite;
        }

        .pulse-dot-inner {
            position: relative;
            z-index: 2;
            border-radius: 50%;
            border: 2px solid;
        }

        /* Default red dot */
        .pulse-dot-red .pulse-ring {
            background: rgba(219, 55, 19, 0.6);
        }

        .pulse-dot-red .pulse-dot-inner {
            background: #db3713;
            border-color: #edf0f0;
            width: 22px;
            height: 22px;
        }

        /* Green dot for carrier vehicle */
        .pulse-dot-green .pulse-ring {
            background: rgba(84, 199, 116, 0.6);
        }

        .pulse-dot-green .pulse-dot-inner {
            background: #54c774;
            border-color: #54c774;
            width: 22px;
            height: 22px;
        }

        /* Grey dot */
        .pulse-dot-grey .pulse-ring {
            background: rgba(55, 64, 83, 0.6);
        }

        .pulse-dot-grey .pulse-dot-inner {
            background: #374053;
            border-color: #edf0f0;
            width: 22px;
            height: 22px;
        }

        @keyframes pulse {
            0% { 
                transform: scale(0.33); 
                opacity: 1; 
            }
            80%, 100% { 
                transform: scale(1); 
                opacity: 0; 
            }
        }

        /* Alternative animation styles */
        .pulse-dot-smooth .pulse-ring {
            animation: pulse-smooth 2s ease-in-out infinite;
        }

        @keyframes pulse-smooth {
            0% { 
                transform: scale(0.2); 
                opacity: 0.8; 
            }
            50% { 
                transform: scale(0.8); 
                opacity: 0.4; 
            }
            100% { 
                transform: scale(1.2); 
                opacity: 0; 
            }
        }

        .pulse-dot-fast .pulse-ring {
            animation: pulse-fast 1s ease-out infinite;
        }

        @keyframes pulse-fast {
            0% { 
                transform: scale(0.1); 
                opacity: 1; 
            }
            100% { 
                transform: scale(1.5); 
                opacity: 0; 
            }
        }

        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            padding: 8px 16px;
            background: #333;
            color: white;
            border: 1px solid #555;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            background: #444;
        }

        button.active {
            background: #54c774;
        }

        .info {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            max-width: 600px;
        }

        /* Map styles */
        .map-container {
            width: 100%;
            height: 500px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            margin: 20px 0;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Map marker styles */
        .map-marker {
            position: relative;
            width: 75px;
            height: 75px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .map-marker .pulse-ring {
            position: absolute;
            border-radius: 50%;
            animation: pulse 2s cubic-bezier(0.455, 0.03, 0.515, 0.955) infinite;
            width: 100%;
            height: 100%;
        }

        .map-marker .pulse-dot-inner {
            position: relative;
            z-index: 2;
            border-radius: 50%;
            border: 2px solid;
        }

        /* Map marker color variants */
        .map-marker-red .pulse-ring {
            background: rgba(219, 55, 19, 0.6);
        }

        .map-marker-red .pulse-dot-inner {
            background: #db3713;
            border-color: #edf0f0;
            width: 22px;
            height: 22px;
        }

        .map-marker-green .pulse-ring {
            background: rgba(84, 199, 116, 0.6);
        }

        .map-marker-green .pulse-dot-inner {
            background: #54c774;
            border-color: #54c774;
            width: 22px;
            height: 22px;
        }

        .map-marker-grey .pulse-ring {
            background: rgba(55, 64, 83, 0.6);
        }

        .map-marker-grey .pulse-dot-inner {
            background: #374053;
            border-color: #edf0f0;
            width: 22px;
            height: 22px;
        }

        .map-section {
            width: 100%;
            max-width: 1000px;
        }

        .map-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <h1>Pulsing Dot CSS Animation Demo</h1>
        
        <div class="demo-section">
            <div class="demo-title">Default Red Dot</div>
            <div class="pulse-dot pulse-dot-red">
                <div class="pulse-ring"></div>
                <div class="pulse-dot-inner"></div>
            </div>
        </div>

        <div class="demo-section">
            <div class="demo-title">Green Dot (Carrier Vehicle)</div>
            <div class="pulse-dot pulse-dot-green">
                <div class="pulse-ring"></div>
                <div class="pulse-dot-inner"></div>
            </div>
        </div>

        <div class="demo-section">
            <div class="demo-title">Grey Dot</div>
            <div class="pulse-dot pulse-dot-grey">
                <div class="pulse-ring"></div>
                <div class="pulse-dot-inner"></div>
            </div>
        </div>

        <div class="demo-section">
            <div class="demo-title">Animation Variations</div>
            <div style="display: flex; gap: 40px; flex-wrap: wrap; justify-content: center;">
                <div>
                    <div style="text-align: center; margin-bottom: 10px;">Smooth</div>
                    <div class="pulse-dot pulse-dot-red pulse-dot-smooth">
                        <div class="pulse-ring"></div>
                        <div class="pulse-dot-inner"></div>
                    </div>
                </div>
                <div>
                    <div style="text-align: center; margin-bottom: 10px;">Fast</div>
                    <div class="pulse-dot pulse-dot-green pulse-dot-fast">
                        <div class="pulse-ring"></div>
                        <div class="pulse-dot-inner"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="map-section">
            <div class="map-title">Pulsing Dots on Mapbox Map</div>
            <div class="map-container">
                <div id="map"></div>
            </div>
            <div class="controls">
                <button onclick="toggleMapMarkers('red')" id="btn-map-red">Toggle Red Markers</button>
                <button onclick="toggleMapMarkers('green')" id="btn-map-green">Toggle Green Markers</button>
                <button onclick="toggleMapMarkers('grey')" id="btn-map-grey">Toggle Grey Markers</button>
                <button onclick="addRandomMarker()" id="btn-add-marker">Add Random Marker</button>
                <button onclick="switchToEfficientMode()" id="btn-efficient">Switch to Efficient Mode</button>
                <button onclick="switchToCSSMode()" id="btn-css">Switch to CSS Overlay Mode</button>
            </div>
        </div>

        <div class="controls">
            <button onclick="toggleAnimation('red')" id="btn-red">Toggle Red</button>
            <button onclick="toggleAnimation('green')" id="btn-green">Toggle Green</button>
            <button onclick="toggleAnimation('grey')" id="btn-grey">Toggle Grey</button>
        </div>

        <div class="info">
            <h3>Implementation Comparison:</h3>
            
            <h4>🎨 CSS Animations (Demo Section):</h4>
            <ul>
                <li><strong>GPU Accelerated:</strong> CSS animations are handled by the GPU, not the CPU</li>
                <li><strong>No Canvas Redrawing:</strong> No continuous canvas operations at 60fps</li>
                <li><strong>VM Friendly:</strong> Minimal resource usage, perfect for virtual machines</li>
                <li><strong>Smooth Performance:</strong> Hardware-accelerated animations</li>
                <li><strong>Easy Customization:</strong> Simple CSS properties to modify colors, timing, and effects</li>
            </ul>
            
            <h4>🗺️ Mapbox addLayer (Map Implementation):</h4>
            <ul>
                <li><strong>Native Integration:</strong> Uses Mapbox's native rendering engine</li>
                <li><strong>Scalable Performance:</strong> Can handle thousands of pulsing dots efficiently</li>
                <li><strong>Data-Driven Styling:</strong> Dynamic styling based on GeoJSON properties</li>
                <li><strong>Zoom Responsive:</strong> Automatically scales with map zoom level</li>
                <li><strong>Interactive Features:</strong> Easy to add click handlers, popups, and interactions</li>
                <li><strong>Memory Efficient:</strong> No DOM elements, pure GPU rendering</li>
            </ul>
            
            <h3>Key Implementation Details:</h3>
            <ul>
                <li><strong>CSS Method:</strong> <code>animation: pulse 2s cubic-bezier(0.455, 0.03, 0.515, 0.955) infinite;</code></li>
                <li><strong>Mapbox Method:</strong> <code>requestAnimationFrame</code> with <code>setPaintProperty()</code></li>
                <li><strong>Scale Animation:</strong> <code>transform: scale(0.33)</code> to <code>scale(1.0)</code></li>
                <li><strong>Opacity Fade:</strong> <code>opacity: 1</code> to <code>opacity: 0</code></li>
                <li><strong>Duration:</strong> 2 seconds with smooth easing curves</li>
            </ul>
            
            <h3>Performance Benefits:</h3>
            <ul>
                <li><strong>CSS Animations:</strong> Best for static demos and UI elements</li>
                <li><strong>Mapbox Layers:</strong> Best for map-based applications with many markers</li>
                <li><strong>Hybrid Approach:</strong> Use CSS for demos, Mapbox layers for production maps</li>
            </ul>
        </div>
    </div>

    <script>
        // Global variables
        let map;
        let markers = {
            red: [],
            green: [],
            grey: []
        };

        // Initialize Mapbox map
        function initMap() {
            // You'll need to replace 'YOUR_MAPBOX_ACCESS_TOKEN' with your actual Mapbox access token
            mapboxgl.accessToken = 'pk.eyJ1IjoiaHVudGFwcGxlZ2F0ZSIsImEiOiJjbWc5bjA5bmgwYWY0MmtvdW12eWo5cjZzIn0.bFFqd6EHoa2F-CPvvKz8WQ'; // Replace with your token
            
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/dark-v11', // Dark theme to match the demo
                center: [-74.5, 40], // New York area
                zoom: 9
            });

            // Wait for map to load before adding layers
            map.on('load', function() {
                setupPulsingDots();
            });
        }

        // Setup pulsing dots using efficient data-driven approach
        function setupPulsingDots() {
            // Create GeoJSON data with animation properties
            const pulsingDotsData = {
                type: 'FeatureCollection',
                features: [
                    {
                        type: 'Feature',
                        properties: { 
                            id: 'red-dot',
                            color: 'red',
                            type: 'pulsing-dot',
                            animationOffset: 0, // Start time offset
                            baseRadius: 20,
                            innerRadius: 8
                        },
                        geometry: {
                            type: 'Point',
                            coordinates: [-74.5, 40]
                        }
                    },
                    {
                        type: 'Feature',
                        properties: { 
                            id: 'green-dot',
                            color: 'green',
                            type: 'pulsing-dot',
                            animationOffset: 0.33, // Offset for staggered animation
                            baseRadius: 20,
                            innerRadius: 8
                        },
                        geometry: {
                            type: 'Point',
                            coordinates: [-74.3, 40.1]
                        }
                    },
                    {
                        type: 'Feature',
                        properties: { 
                            id: 'grey-dot',
                            color: 'grey',
                            type: 'pulsing-dot',
                            animationOffset: 0.66, // Offset for staggered animation
                            baseRadius: 20,
                            innerRadius: 8
                        },
                        geometry: {
                            type: 'Point',
                            coordinates: [-74.7, 39.9]
                        }
                    }
                ]
            };

            // Add pulsing dots source
            map.addSource('pulsing-dots', {
                type: 'geojson',
                data: pulsingDotsData
            });

            // Add pulsing ring layer with time-based expressions
            map.addLayer({
                id: 'pulsing-rings',
                type: 'circle',
                source: 'pulsing-dots',
                paint: {
                    'circle-radius': {
                        'base': 1.75,
                        'stops': [
                            [1, ['*', ['get', 'baseRadius'], 0.33]], // Start at 33% size
                            [20, ['*', ['get', 'baseRadius'], 1.0]]   // Scale to 100% size
                        ]
                    },
                    'circle-color': [
                        'case',
                        ['==', ['get', 'color'], 'red'], '#db3713',
                        ['==', ['get', 'color'], 'green'], '#54c774',
                        ['==', ['get', 'color'], 'grey'], '#374053',
                        '#db3713'
                    ],
                    'circle-opacity': 0.6,
                    'circle-stroke-width': 0
                }
            });

            // Add inner dot layer (static)
            map.addLayer({
                id: 'pulsing-dots-inner',
                type: 'circle',
                source: 'pulsing-dots',
                paint: {
                    'circle-radius': {
                        'base': 1.75,
                        'stops': [
                            [1, ['get', 'innerRadius']],
                            [20, ['*', ['get', 'innerRadius'], 1.5]]
                        ]
                    },
                    'circle-color': [
                        'case',
                        ['==', ['get', 'color'], 'red'], '#db3713',
                        ['==', ['get', 'color'], 'green'], '#54c774',
                        ['==', ['get', 'color'], 'grey'], '#374053',
                        '#db3713'
                    ],
                    'circle-opacity': 1,
                    'circle-stroke-color': '#edf0f0',
                    'circle-stroke-width': 2
                }
            });

            // Use a more efficient animation approach
            startEfficientPulsingAnimation();
        }

        // More efficient animation using CSS-like approach with reduced updates
        let animationId;
        let startTime = Date.now();
        let lastUpdate = 0;
        const updateInterval = 100; // Update every 100ms instead of every frame (60fps -> 10fps)

        // Start efficient pulsing animation
        function startEfficientPulsingAnimation() {
            function animate() {
                const now = Date.now();
                if (now - lastUpdate < updateInterval) {
                    animationId = requestAnimationFrame(animate);
                    return; // Skip this frame
                }
                lastUpdate = now;
                
                const elapsed = now - startTime;
                const duration = 2000; // 2 seconds
                const t = (elapsed % duration) / duration;
                
                // Calculate pulsing scale (0.33 to 1.0)
                const scale = 0.33 + (0.67 * t);
                const opacity = 1 - t;
                
                // Update the pulsing rings layer (reduced frequency)
                map.setPaintProperty('pulsing-rings', 'circle-radius', {
                    'base': 1.75,
                    'stops': [
                        [1, 20 * scale],
                        [20, 30 * scale]
                    ]
                });
                
                map.setPaintProperty('pulsing-rings', 'circle-opacity', opacity);
                
                animationId = requestAnimationFrame(animate);
            }
            
            animate();
        }

        // Alternative: Use CSS animations on a single overlay layer (most efficient)
        function createCSSPulsingOverlay() {
            // Remove existing layers
            if (map.getLayer('pulsing-rings')) map.removeLayer('pulsing-rings');
            if (map.getLayer('pulsing-dots-inner')) map.removeLayer('pulsing-dots-inner');
            
            // Create a single overlay with CSS animations
            const overlay = document.createElement('div');
            overlay.id = 'pulsing-overlay';
            overlay.style.position = 'absolute';
            overlay.style.pointerEvents = 'none';
            overlay.style.zIndex = '1000';
            
            // Add CSS for pulsing animation
            const style = document.createElement('style');
            style.textContent = `
                .pulsing-overlay-dot {
                    position: absolute;
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    transform: translate(-50%, -50%);
                    pointer-events: none;
                }
                .pulsing-overlay-dot::before {
                    content: '';
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    border-radius: 50%;
                    animation: pulse-overlay 2s infinite;
                }
                @keyframes pulse-overlay {
                    0% { transform: scale(0.33); opacity: 1; }
                    80%, 100% { transform: scale(1); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
            
            // Add dots to overlay
            const dots = [
                { color: '#db3713', lng: -74.5, lat: 40 },
                { color: '#54c774', lng: -74.3, lat: 40.1 },
                { color: '#374053', lng: -74.7, lat: 39.9 }
            ];
            
            dots.forEach(dot => {
                const dotEl = document.createElement('div');
                dotEl.className = 'pulsing-overlay-dot';
                dotEl.style.backgroundColor = dot.color;
                dotEl.style.border = '2px solid #edf0f0';
                overlay.appendChild(dotEl);
                
                // Position using map projection
                const pos = map.project([dot.lng, dot.lat]);
                dotEl.style.left = pos.x + 'px';
                dotEl.style.top = pos.y + 'px';
            });
            
            // Add overlay to map container
            map.getContainer().appendChild(overlay);
            
            // Update positions on map move
            map.on('move', updateOverlayPositions);
            map.on('zoom', updateOverlayPositions);
        }
        
        function updateOverlayPositions() {
            const overlay = document.getElementById('pulsing-overlay');
            if (!overlay) return;
            
            const dots = [
                { lng: -74.5, lat: 40 },
                { lng: -74.3, lat: 40.1 },
                { lng: -74.7, lat: 39.9 }
            ];
            
            const dotElements = overlay.querySelectorAll('.pulsing-overlay-dot');
            dots.forEach((dot, index) => {
                if (dotElements[index]) {
                    const pos = map.project([dot.lng, dot.lat]);
                    dotElements[index].style.left = pos.x + 'px';
                    dotElements[index].style.top = pos.y + 'px';
                }
            });
        }

        // Stop the pulsing animation
        function stopPulsingAnimation() {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
        }

        // Switch to efficient mode (reduced update frequency)
        function switchToEfficientMode() {
            stopPulsingAnimation();
            
            // Remove CSS overlay if it exists
            const overlay = document.getElementById('pulsing-overlay');
            if (overlay) overlay.remove();
            
            // Recreate layers with efficient animation
            setupPulsingDots();
            
            document.getElementById('btn-efficient').textContent = 'Efficient Mode Active';
            document.getElementById('btn-css').textContent = 'Switch to CSS Overlay Mode';
        }

        // Switch to CSS overlay mode (most efficient)
        function switchToCSSMode() {
            stopPulsingAnimation();
            
            // Remove existing layers
            if (map.getLayer('pulsing-rings')) map.removeLayer('pulsing-rings');
            if (map.getLayer('pulsing-dots-inner')) map.removeLayer('pulsing-dots-inner');
            if (map.getSource('pulsing-dots')) map.removeSource('pulsing-dots');
            
            // Create CSS overlay
            createCSSPulsingOverlay();
            
            document.getElementById('btn-css').textContent = 'CSS Overlay Mode Active';
            document.getElementById('btn-efficient').textContent = 'Switch to Efficient Mode';
        }

        // Legacy marker functions (kept for compatibility but not used in layer-based approach)
        // These are now replaced by the addLayer implementation above

        // Toggle map markers visibility using layer visibility
        function toggleMapMarkers(color) {
            const button = document.getElementById(`btn-map-${color}`);
            const ringsLayer = map.getLayer('pulsing-rings');
            const innerLayer = map.getLayer('pulsing-dots-inner');
            
            if (!ringsLayer || !innerLayer) return;
            
            const isVisible = map.getLayoutProperty('pulsing-rings', 'visibility') !== 'none';
            
            // Toggle visibility
            const visibility = isVisible ? 'none' : 'visible';
            map.setLayoutProperty('pulsing-rings', 'visibility', visibility);
            map.setLayoutProperty('pulsing-dots-inner', 'visibility', visibility);
            
            button.textContent = isVisible ? `Show ${color.charAt(0).toUpperCase() + color.slice(1)} Markers` : `Hide ${color.charAt(0).toUpperCase() + color.slice(1)} Markers`;
            button.classList.toggle('active', !isVisible);
        }

        // Add a random marker using layer data
        function addRandomMarker() {
            const colors = ['red', 'green', 'grey'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            
            // Random coordinates around the current map center
            const center = map.getCenter();
            const lng = center.lng + (Math.random() - 0.5) * 0.1;
            const lat = center.lat + (Math.random() - 0.5) * 0.1;
            
            // Get current data
            const source = map.getSource('pulsing-dots');
            const currentData = source._data;
            
            // Add new feature
            const newFeature = {
                type: 'Feature',
                properties: { 
                    id: `${color}-dot-${Date.now()}`,
                    color: color,
                    type: 'pulsing-dot'
                },
                geometry: {
                    type: 'Point',
                    coordinates: [lng, lat]
                }
            };
            
            currentData.features.push(newFeature);
            source.setData(currentData);
        }

        // Original toggle animation function
        function toggleAnimation(color) {
            const dots = document.querySelectorAll(`.pulse-dot-${color}`);
            const button = document.getElementById(`btn-${color}`);
            
            dots.forEach(dot => {
                const ring = dot.querySelector('.pulse-ring');
                if (ring.style.animationPlayState === 'paused') {
                    ring.style.animationPlayState = 'running';
                    button.textContent = `Pause ${color.charAt(0).toUpperCase() + color.slice(1)}`;
                    button.classList.add('active');
                } else {
                    ring.style.animationPlayState = 'paused';
                    button.textContent = `Resume ${color.charAt(0).toUpperCase() + color.slice(1)}`;
                    button.classList.remove('active');
                }
            });
        }

        // Debug function to test animation
        function testAnimation() {
            console.log('Testing animation...');
            const testDiv = document.createElement('div');
            testDiv.style.position = 'fixed';
            testDiv.style.top = '10px';
            testDiv.style.left = '10px';
            testDiv.style.zIndex = '9999';
            testDiv.innerHTML = `
                <div class="pulse-dot pulse-dot-red">
                    <div class="pulse-ring"></div>
                    <div class="pulse-dot-inner"></div>
                </div>
            `;
            document.body.appendChild(testDiv);
            
            setTimeout(() => {
                document.body.removeChild(testDiv);
            }, 5000);
        }

        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize button text for demo controls
            document.getElementById('btn-red').textContent = 'Pause Red';
            document.getElementById('btn-green').textContent = 'Pause Green';
            document.getElementById('btn-grey').textContent = 'Pause Grey';
            
            // Initialize map
            initMap();
            
            // Test animation after a short delay
            setTimeout(testAnimation, 1000);
        });
    </script>
</body>
</html>
<!-- Updated Thu Oct  2 10:56:16 CST 2025 -->
